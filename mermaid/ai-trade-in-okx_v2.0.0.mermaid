flowchart TD

%% ===================== A. 数据输入层 =====================
subgraph A[数据输入层]
  A1["交易所WS\n价格·深度·成交·Funding"]
  A2["新闻与舆情接口"]
  A3["账户与持仓状态"]
  A4["最近交易数据及决策原因"]
end

%% ===================== B. 指标监控层 =====================
subgraph B[指标监控层]
  B1["实时特征与指标计算 
    RSI·波动率·价格变化·盘口不平衡"]
  B2["阈值与迟滞检测
    上阈与下阈 双阈 Hysteresis"]
  B4["显著度评分器
    score 0到1"]
  B3["事件总线与优先队列
    合并 Grace Window 15到30秒 与 去重"]
end

%% ===================== C. 自适应调度器 =====================
subgraph C[自适应调度器]
  C1["长周期计时器
    默认12分钟"]
  C2["短周期计时器
    5分钟模式"]
  C3["周期管理器
    边沿触发→短周期
    回落稳定→长周期"]
  C4["冷却与幂等
    Idempotency Key·TTL·合并策略"]
  C5["预算与限流
    并发·QPS·费用·超时"]
end

%% ===================== L. Letta-AI 服务（中间层） =====================
subgraph L[Letta-AI 服务]
  L1["Core Memory策略原则·风控红线·输出规范"]
  L2["Episodic Memory
    往期交易与理由
    会话级临时记忆"]
  L3["Prompt 模板与工具
    由 Letta 统一管理"]
  L4["模型路由
    model_id 与 后端模型地址"]
end

%% ===================== D. 决策适配器（本地） =====================
subgraph D[AI 决策适配器]
  D1["上下文封装器
    把 行情·账户·持仓·新闻
    封成 单轮消息"]
  D2["Letta API 客户端
    传入 session_id 与 model_id
    仅单轮对话"]
  D3["结构化输出校验
    严格 JSON Schema 解析"]
end

%% ===================== E. 风控与执行 =====================
subgraph E[风险控制与执行]
  E1["风控审查
    限额·滑点·仓位暴露·跨所价差·熔断"]
  E2["订单执行
    条件单·保护单 触发价·超时撤单"]
  E3["执行结果回写
    订单·拒单原因·延迟"]
end

%% ===================== F. 状态存储与反馈 =====================
subgraph F[状态存储与反馈]
  F1["Redis 缓存
    指标快照·周期状态·冷却与幂等键"]
  F2["数据库 或 ES 或 ClickHouse
    交易记录·决策日志·审计可重放"]
  F3["周期恢复逻辑
    指标回落稳定→恢复12分钟"]
end

%% ===================== G. 观测与灰度 =====================
subgraph G[观测与灰度发布]
  G1["影子与灰度开关
    按品种与时段控制权重"]
  G2["可观测性仪表盘
    触发来源占比·响应时延·拒单Top5·影子vs实盘"]
  G3["全局熔断控制
    日内最大回撤超阈→冷静期"]
end

%% ===== 数据流 =====
A1 --> B1
A2 --> B1
A3 --> B1
A4 --> B1

B1 --> B2
B2 --> B4
B4 --> B3

C1 -- "周期到达" --> B3
B3 -- "高优先 Up·Down·Spike" --> C3
B3 -- "定时事件" --> C3

C3 --> C4
C4 --> C5
C3 -- "触发AI 或 切短周期" --> D1
C2 -- "短周期触发" --> D1

%% 本地仅封装与调用 Letta
D1 --> D2
D2 --> L4
L1 --> L3
L2 --> L3
L3 --> L4
L4 --> D2
D2 --> D3
D3 --> E1 --> E2 --> E3

%% 回写与记忆
E3 --> F1
E3 --> F2
F1 --> B1
F1 --> C3

%% 把结果事实写回 Letta 作为记忆（通过 D2 再次调用 Letta 的记忆接口或同会话消息）
E3 -. "结果与理由 写入会话记忆" .-> D2

%% 观测与灰度
E3 --> G2
D3 --> G2
G1 --> E2
G1 --> C5
G3 --> C3
G3 --> C1

%% 恢复逻辑
F2 -. "复盘与审计重放" .-> D1
F3 -. "回落稳定→恢复12分钟" .-> C3
