flowchart TD

subgraph A["数据输入层"]
  A1["交易所 api<br/>(价格、深度、成交、Funding Rate 等)"]
  A2["新闻与舆情接口"]
  A3["账户与持仓状态"]
  A4["最近交易数据及决策原因"]
end

subgraph B["指标监控层"]
  B1["实时指标计算<br/>(RSI、波动率、价格变化、MACD 等)"]
  B2["阈值检测器<br/>检测上阈/下阈"]
  B3["事件订阅控制<br/>触发AI调用"]
end

subgraph C["自适应调度器"]
  C1["周期计时器<br/>默认12分钟"]
end

subgraph D["AI决策引擎"]
  D1["上下文拼接器<br/>(行情 + 持仓 + 账户 + 决策历史)"]
  D2["Prompt生成器"]
  D3["AI模型调用<br/>(Qwen / GPT / DeepSeek)"]
  D4["结构化输出解析器<br/>JSON决策结果"]
end

subgraph E["风险控制与执行"]
  E1["风控审查器<br/>(限额 / 滑点 / 杠杆 / 熔断)"]
  E2["订单执行器<br/>(REST / WebSocket)"]
  E3["执行结果回写<br/>日志与状态"]
end

subgraph F["状态存储与反馈"]
  F2["数据库<br/>交易记录与决策日志"]
end

A1 --> B1
A2 --> B1
A3 --> B1
A4 --> B1
B1 --> B2
B2 -->|指标上阈触发| C1
C1 -->|周期到达| D1
D1 --> D2
D2 --> D3
D3 --> D4
E3 --> F2
F2 --> D1
D4 --> E1
E1 --> E2
E2 --> E3